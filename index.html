<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Musik</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #6a11cb, #2575fc);
      color: white;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .dashboard { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .main-content { flex: 1; padding: 20px; overflow-y: auto; }
    .song-list { margin-top: 10px; }
    .song-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px; margin-bottom: 6px;
      background: rgba(255,255,255,0.15); border-radius: 8px;
      cursor: pointer; transition: 0.3s; font-size: 14px;
    }
    .song-item:hover { background: rgba(255,255,255,0.3); }
    .song-item.active { background: rgba(255,255,255,0.6); color: #000; font-weight: bold; }
    .song-info { flex: 1; display: flex; align-items: center; gap: 8px; }
    .song-info input { cursor: pointer; }

    .player {
      background: rgba(0,0,0,0.85);
      display: flex; flex-direction: column; align-items: center;
      gap: 8px; padding: 12px 16px 14px;
    }
    .cover { width: 90px; height: 90px; border-radius: 10px; background: #444; overflow: hidden; }
    .cover img { width: 100%; height: 100%; object-fit: cover; }
    .title-artist { text-align: center; line-height: 1.2; }
    .title-artist .title { font-weight: bold; font-size: 14px; }
    .title-artist .artist { font-size: 12px; color: #bbb; }

    .player-controls { display: flex; align-items: center; justify-content: space-between; width: 100%; gap: 10px; }
    .controls button {
      padding: 8px 12px; border: none; border-radius: 6px;
      background: #fff; color: #2575fc; font-size: 16px;
      cursor: pointer; transition: 0.3s; font-weight: bold;
    }
    .controls button:hover { background: #e0e0ff; }
    .audio-box { flex: 1; }
    audio { width: 100%; outline: none; }

    .upload-box { margin-top: 10px; display: flex; gap: 10px; }
    input[type="file"] { display: none; }
    label, .delete-btn {
      display: inline-block; padding: 8px 14px;
      background: #fff; color: #2575fc;
      border-radius: 8px; cursor: pointer;
      transition: 0.3s; font-weight: bold;
    }
    label:hover, .delete-btn:hover { background: #e0e0ff; }

    .mini-sidebar {
      width: 100%; height: 54px;
      background: rgba(0,0,0,0.95);
      display: flex; align-items: center; justify-content: space-around;
      border-top: 1px solid rgba(255,255,255,0.2);
    }
    .mini-sidebar a {
      flex: 1; text-align: center; padding: 8px 0; font-size: 20px;
      text-decoration: none; color: #fff;
      border-right: 1px solid rgba(255,255,255,0.2);
      transition: background 0.2s, color 0.2s;
    }
    .mini-sidebar a:last-child { border-right: none; }
    .mini-sidebar a:hover { background: rgba(255,255,255,0.15); color: #a9c6ff; }
    .mini-sidebar a.active { background: rgba(255,255,255,0.25); color: #a9c6ff; }

    /* Canvas Rainbow Graph */
    #visualizer {
      width: 100%;
      height: 120px;
      display: block;
      background: transparent;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="main-content">
      <h2>Daftar Lagu</h2>
      <div class="upload-box">
        <input type="file" id="fileInput" accept="audio/*" multiple>
        <label for="fileInput">+ Tambah Lagu</label>
        <button class="delete-btn" id="deleteSelected">üóëÔ∏è Hapus Terpilih</button>
      </div>
      <div class="song-list" id="songList"></div>
    </div>
  </div>

  <!-- Rainbow Chart -->
  <canvas id="visualizer"></canvas>

  <!-- Player -->
  <div class="player">
    <div class="cover" id="cover"></div>
    <div class="title-artist">
      <span class="title" id="songTitle">Tidak ada lagu</span><br>
      <span class="artist" id="songArtist">Unknown</span>
    </div>
    <div class="player-controls">
      <div class="controls"><button id="prevBtn">‚èÆÔ∏è</button></div>
      <div class="audio-box"><audio id="audioPlayer" controls></audio></div>
      <div class="controls"><button id="nextBtn">‚è≠Ô∏è</button></div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="mini-sidebar">
    <a href="https://kingzzz999.github.io/Dash/" class="active">üè†</a>
    <a href="https://kingzzz999.github.io/Favv/">‚ù§Ô∏è</a>
    <a href="https://kingzzz999.github.io/Play/">üéß</a>
    <a href="https://kingzzz999.github.io/Setting/">‚öôÔ∏è</a>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const songList = document.getElementById("songList");
    const audioPlayer = document.getElementById("audioPlayer");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const songTitle = document.getElementById("songTitle");
    const songArtist = document.getElementById("songArtist");
    const cover = document.getElementById("cover");
    const deleteSelectedBtn = document.getElementById("deleteSelected");

    let songs = [];
    let currentIndex = 0;

    // === IndexedDB setup ===
    let db;
    const request = indexedDB.open("MusicDB", 1);
    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("songs")) {
        db.createObjectStore("songs", { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = e => {
      db = e.target.result;
      loadSongsFromDB();
    };
    request.onerror = e => console.error("IndexedDB error:", e);

    function saveSongToDB(song) {
      const tx = db.transaction("songs", "readwrite");
      const store = tx.objectStore("songs");
      store.add(song);
    }

    function loadSongsFromDB() {
      const tx = db.transaction("songs", "readonly");
      const store = tx.objectStore("songs");
      const getAll = store.getAll();
      getAll.onsuccess = () => {
        songs = getAll.result.map(s => ({
          id: s.id, name: s.name, blob: s.blob, url: URL.createObjectURL(s.blob)
        }));
        renderSongs();
      };
    }

    function deleteSongsFromDB(ids) {
      const tx = db.transaction("songs", "readwrite");
      const store = tx.objectStore("songs");
      ids.forEach(id => store.delete(id));
      tx.oncomplete = () => {
        songs = songs.filter(song => !ids.includes(song.id));
        renderSongs();
      };
    }

    function renderSongs() {
      songList.innerHTML = "";
      songs.forEach((song, index) => {
        const songItem = document.createElement("div");
        songItem.classList.add("song-item");

        const info = document.createElement("div");
        info.classList.add("song-info");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.dataset.id = song.id;

        const nameSpan = document.createElement("span");
        nameSpan.textContent = song.name;

        info.appendChild(checkbox);
        info.appendChild(nameSpan);

        songItem.appendChild(info);

        songItem.addEventListener("click", (e) => {
          if (e.target.tagName !== "INPUT") { // biar checkbox ga ganggu play
            currentIndex = index;
            loadSong();
            audioPlayer.play();
          }
        });

        songList.appendChild(songItem);
      });
    }

    function loadSong() {
      if (songs.length > 0) {
        audioPlayer.src = songs[currentIndex].url;
        songTitle.textContent = songs[currentIndex].name;
        songArtist.textContent = "Unknown Artist";
        cover.innerHTML = `<img src="https://files.catbox.moe/vc5n3k.jpeg" alt="cover">`;

        document.querySelectorAll(".song-item").forEach((el, i) => {
          el.classList.toggle("active", i === currentIndex);
        });
      }
    }

    prevBtn.addEventListener("click", () => {
      if (songs.length > 0) {
        currentIndex = (currentIndex - 1 + songs.length) % songs.length;
        loadSong();
        audioPlayer.play();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (songs.length > 0) {
        currentIndex = (currentIndex + 1) % songs.length;
        loadSong();
        audioPlayer.play();
      }
    });

    audioPlayer.addEventListener("ended", () => { nextBtn.click(); });

    fileInput.addEventListener("change", (e) => {
      const files = Array.from(e.target.files);
      files.forEach(file => {
        if (file.type.startsWith("audio/")) {
          const reader = new FileReader();
          reader.onload = evt => {
            const blob = new Blob([evt.target.result], { type: file.type });
            const song = { name: file.name, blob: blob };
            saveSongToDB(song);
            songs.push({ ...song, url: URL.createObjectURL(blob), id: Date.now() + Math.random() });
            renderSongs();
          };
          reader.readAsArrayBuffer(file);
        }
      });
    });

    deleteSelectedBtn.addEventListener("click", () => {
      const selected = [...document.querySelectorAll(".song-info input:checked")];
      const ids = selected.map(cb => parseInt(cb.dataset.id));
      if (ids.length > 0) {
        deleteSongsFromDB(ids);
      }
    });

    // === Rainbow Chart Animation ===
    const canvas = document.getElementById("visualizer");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    let offset = 0;
    function drawRainbowGraph() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
      gradient.addColorStop(0, "red");
      gradient.addColorStop(0.2, "orange");
      gradient.addColorStop(0.4, "yellow");
      gradient.addColorStop(0.6, "green");
      gradient.addColorStop(0.8, "blue");
      gradient.addColorStop(1, "violet");

      ctx.strokeStyle = gradient;
      ctx.lineWidth = 2;
      ctx.beginPath();

      for (let x = 0; x < canvas.width; x++) {
        let y = canvas.height / 2 +
                Math.sin((x + offset) * 0.05) * 30 +
                Math.cos((x + offset) * 0.02) * 20;
        ctx.lineTo(x, y);
      }

      ctx.stroke();
      offset += 2;
      requestAnimationFrame(drawRainbowGraph);
    }

    drawRainbowGraph();
  </script>
</body>
</html>